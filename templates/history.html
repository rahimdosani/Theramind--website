<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Theramind ‚Äì History</title>
<link rel="icon" type="image/png" href="{{ url_for('static', filename='history.png') }}">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tsparticles@2.11.1/tsparticles.bundle.min.js"></script>

<style>
/* ======================================================
   üåó THEME VARIABLES
====================================================== */
:root {
  --background: #ffffff;
  --foreground: #111111;
  --primary: #4f46e5;
  --accent: #06b6d4;

  --bubble-user: #dbeafe;
  --bubble-bot: #f9fafb;

  --sidebar-bg: rgba(255, 255, 255, 0.85);
  --button-bg: var(--primary);
  --button-color: #ffffff;
  --link-color: var(--primary);

  --glass-blur: blur(16px) saturate(180%);
}

body.dark-theme {
  --background: #0d0d0f;
  --foreground: #f0f0f0;
  --primary: #6366f1;
  --accent: #67e8f9;

  --bubble-user: #1e1e1e;
  --bubble-bot: #222222;

  --sidebar-bg: rgba(30,30,30,0.85);
  --button-bg: var(--primary);
  --button-color: #ffffff;
  --link-color: var(--accent);
}

/* ======================================================
   üåç BASE
====================================================== */
body {
  margin: 0;
  font-family: 'Poppins', sans-serif;
  background: var(--background);
  color: var(--foreground);
  transition: background 0.3s ease, color 0.3s ease;
  isolation: isolate; /* IMPORTANT: isolates stacking contexts */
}

/* ======================================================
   ‚ú® PARTICLES (FIXED)
====================================================== */
#tsparticles {
  position: fixed;
  inset: 0;
  z-index: 0;
  pointer-events: none;

  /* Ensures smooth compositing under glass layers */
  will-change: transform, opacity;
}

/* ======================================================
   üß≠ NAVBAR (UNTOUCHED)
====================================================== */
.tm-nav {
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: 75px;
  padding: 0 2rem;
  background: var(--sidebar-bg);
  backdrop-filter: var(--glass-blur);
  -webkit-backdrop-filter: var(--glass-blur);
  box-shadow: 0 6px 25px rgba(0,0,0,0.15);
  position: sticky;
  top: 0;
  z-index: 1001;
}

.tm-brand {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  font-weight: 700;
  font-size: 1.4rem;
  color: var(--foreground);
  text-decoration: none;
}

.tm-brand img { height:36px; }

.tm-navlinks {
  display: flex;
  gap: 1.5rem;
  flex-wrap: wrap;
  align-items: center;
}

.tm-navlinks a {
  text-decoration: none;
  font-weight: 600;
  color: var(--link-color);
  position: relative;
  transition: color 0.3s;
}

.tm-navlinks a:hover { color: var(--accent); }

.tm-navlinks a.active::after {
  content: '';
  position: absolute;
  bottom: -6px;
  left: 0;
  width: 100%;
  height: 3px;
  background: var(--primary);
  border-radius: 4px;
}

.theme-toggle {
  cursor: pointer;
  font-size: 0.9rem;
  background: linear-gradient(135deg, var(--primary), var(--accent));
  padding: 6px 10px;
  border-radius: 6px;
  color: var(--button-color);
  transition: opacity 0.3s;
}

.theme-toggle:hover { opacity: 0.85; }

.tm-hamburger {
  display: none;
  font-size: 1.8rem;
  cursor: pointer;
}

/* Mobile Navbar */
@media (max-width: 768px) {
  .tm-nav {
    flex-direction: column;
    align-items: flex-start;
    height: auto;
    padding: 1rem;
  }

  .tm-navlinks {
    flex-direction: column;
    align-items: flex-start;
    width: 100%;
    gap: 0.6rem;
    margin-top: 0.5rem;
    display: none;
  }

  .tm-nav.show-links .tm-navlinks { display: flex; }

  .theme-toggle {
    align-self: flex-start;
    margin-top: 0.5rem;
  }

  .tm-hamburger { display: block; }
}

/* ======================================================
   üìú HISTORY CONTAINER
====================================================== */
.history-container {
  position: relative;
  z-index: 1;
  max-width: 1000px;
  margin: 40px auto;
  padding: 30px;
  background: rgba(255,255,255,0.65);
  border-radius: 20px;
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  box-shadow: 0 8px 40px rgba(0,0,0,0.1);
}

body.dark-theme .history-container {
  background: rgba(30,30,30,0.55);
}

h2 {
  font-size: 1.6rem;
  margin-top: 30px;
  padding-bottom: 10px;
  border-bottom: 2px solid var(--primary);
}

/* ======================================================
   üìä SUMMARY DASHBOARD
====================================================== */
.summary-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.summary-card {
  padding: 22px;
  border-radius: 18px;
  background: rgba(255,255,255,0.75);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.08);
  transition: transform 0.25s ease;
}

body.dark-theme .summary-card {
  background: rgba(35,35,45,0.6);
}

.summary-card:hover {
  transform: translateY(-4px);
}

.summary-title {
  font-weight: 600;
  font-size: 0.95rem;
  opacity: 0.85;
}

.summary-sub {
  font-size: 0.85rem;
  opacity: 0.75;
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}

/* Accent borders */
.summary-card.primary { border-left: 5px solid var(--primary); }
.summary-card.accent  { border-left: 5px solid var(--accent); }
.summary-card.calm    { border-left: 5px solid #22c55e; }

/* ======================================================
   üîò WEEKLY / MONTHLY TOGGLE
====================================================== */
.range-toggle {
  border: none;
  background: transparent;
  color: var(--foreground);
  font-size: 0.75rem;
  font-weight: 600;
  padding: 4px 8px;
  border-radius: 6px;
  cursor: pointer;
  opacity: 0.6;
}

.range-toggle.active {
  background: var(--primary);
  color: #ffffff;
  opacity: 1;
}

.range-toggle:not(.active):hover {
  opacity: 0.9;
}

/* ======================================================
   üü¢ WELLNESS SCORE RING
====================================================== */
.score-ring {
  position: relative;
  width: 96px;
  height: 96px;
  margin: 6px 0;
}

.score-ring svg {
  transform: rotate(-90deg);
}

.ring-bg {
  fill: none;
  stroke: rgba(0,0,0,0.08);
  stroke-width: 8;
}

body.dark-theme .ring-bg {
  stroke: rgba(255,255,255,0.15);
}

.ring-progress {
  fill: none;
  stroke: var(--primary);
  stroke-width: 8;
  stroke-linecap: round;
  stroke-dasharray: 264;
  stroke-dashoffset: 264;
  transition: stroke-dashoffset 1s ease, stroke 0.3s ease;
}

.ring-text {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.4rem;
  font-weight: 700;
}

/* ======================================================
   üéõÔ∏è CONTROLS
====================================================== */
.controls {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 20px;
  align-items: center;
}

.controls input,
.controls select {
  padding: 6px 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 0.9rem;
}

.controls input { flex: 1; }

.controls button {
  padding: 6px 12px;
  border-radius: 6px;
  border: none;
  background: var(--button-bg);
  color: var(--button-color);
  font-weight: 600;
  cursor: pointer;
}

.controls button:hover { filter: brightness(0.9); }

/* ======================================================
   üìù ENTRIES & CARDS
====================================================== */
.entry {
  background: rgba(255,255,255,0.85);
  padding: 18px;
  margin: 16px 0;
  border-left: 5px solid var(--primary);
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.07);
  transition: transform 0.2s ease;
}

body.dark-theme .entry {
  background: rgba(50,50,50,0.5);
}

.entry:hover { transform: translateY(-2px); }

.entry strong { display: block; margin-bottom: 6px; }
.entry small  { display: block; opacity: 0.7; margin-bottom: 4px; }

.empty-state {
  text-align: center;
  color: #888;
  margin-top: 20px;
  font-style: italic;
}

/* ======================================================
   üí¨ SAVED CHATS
====================================================== */
.saved-chat-card {
  background: rgba(255,255,255,0.85);
  padding: 14px 16px;
  margin: 12px 0;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  display: flex;
  flex-direction: column;
  gap: 4px;
}

body.dark-theme .saved-chat-card {
  background: rgba(50,50,50,0.5);
}

.saved-chat-title { font-weight: 600; }
.saved-chat-meta  { font-size: 0.8rem; opacity: 0.7; }

/* ======================================================
   üìà CHARTS
====================================================== */
.chart-container {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 30px;
  margin-top: 20px;
}

#chartWrapper {
  flex: 2;
  min-width: 250px;
  min-height: 220px;
}

.pie-wrapper {
  flex: 1;
  min-width: 250px;
  max-width: 350px;
}

canvas {
  width: 100% !important;
  height: auto !important;
}

/* ======================================================
   üì± RESPONSIVE
====================================================== */
@media (max-width: 1024px) {
  .history-container { max-width: 90%; padding: 25px; }
  h2 { font-size: 1.4rem; }
}

@media (max-width: 768px) {
  .controls { flex-direction: column; }
  .chart-container { flex-direction: column; }
  .entry { font-size: 0.9rem; }
}

@media (max-width: 480px) {
  h2 { font-size: 1.2rem; }
  .entry { font-size: 0.85rem; }
}
</style>


</head>
<body>
  <!-- ===================== PARTICLES ===================== -->
  <div id="tsparticles" aria-hidden="true"></div>

  <!-- ===================== NAVBAR ===================== -->
  <header class="tm-nav" role="banner">
    <a class="tm-brand" href="/" aria-label="Theramind Home">
      <img src="https://img.icons8.com/fluency/48/brain.png" alt="Theramind Logo">
      <span>Theramind</span>
    </a>

    <div class="tm-hamburger" aria-label="Toggle navigation" role="button">‚ò∞</div>

    <nav class="tm-navlinks" role="navigation" aria-label="Primary">
      <a href="/">üè† Home</a>
      <a href="/index">üí¨ Chat</a>
      <a href="/journaling">üìì Journal</a>
      <a href="/breathing">ü´Å Breathing</a>
      <a href="/pick-a-peace">üìÉ Pick-a-Peace</a>
      <a href="/calm-corner">üßò Calm Corner</a>
      <a href="/ebooks">üìö E-Books</a>
      <a href="/history" class="active" aria-current="page">üï∞Ô∏è History</a>
    </nav>

    <div class="theme-toggle" id="themeToggle" role="button" aria-label="Toggle theme">
      üåô Theme
    </div>
  </header>

  <!-- ===================== HISTORY DASHBOARD ===================== -->
  <main class="history-container" role="main" aria-busy="true">

    <!-- ===================== SUMMARY DASHBOARD ===================== -->
    <section class="summary-grid" aria-label="Wellness Summary">

      <!-- ===== WELLNESS SCORE ===== -->
      <div class="summary-card primary">
        <div class="summary-title">üìä Wellness Score</div>

        <div class="score-ring" aria-hidden="true">
          <svg width="96" height="96">
            <circle cx="48" cy="48" r="42" class="ring-bg"></circle>
            <circle cx="48" cy="48" r="42" class="ring-progress"></circle>
          </svg>
          <div class="ring-text" id="wellnessScore">--</div>
        </div>

        <div class="summary-sub" role="group" aria-label="Wellness range">
          <button class="range-toggle active" data-range="7" aria-pressed="true">
            Weekly
          </button>
          <button class="range-toggle" data-range="30" aria-pressed="false">
            Monthly
          </button>
        </div>
      </div>

      <!-- ===== BREATHING ===== -->
      <div class="summary-card accent">
        <div class="summary-title">ü´Å Breathing</div>
        <div class="summary-value" id="breathingCount">0</div>
        <div class="summary-sub">
          üî• <span id="breathingStreak">0</span>-day streak
        </div>
      </div>

      <!-- ===== TIME BALANCE ===== -->
      <div class="summary-card calm">
        <div class="summary-title">‚è±Ô∏è Time Balance</div>
        <div class="summary-value">
          <span id="journalMinutes">0</span>m /
          <span id="chatMinutes">0</span>m
        </div>
        <div class="summary-sub">Journal vs Chat</div>
      </div>

    </section>

    <!-- ===================== FILTER CONTROLS ===================== -->
    <section class="controls" aria-label="History Filters">
      <input
        type="text"
        id="searchJournal"
        placeholder="Search journal entries (text, tags, mood)..."
        aria-label="Search journal entries"
      />

      <select id="dateRange" aria-label="Select date range">
        <option value="all">All time</option>
        <option value="7">Last 7 days</option>
        <option value="30">Last 30 days</option>
        <option value="90">Last 90 days</option>
      </select>

      <button id="exportJournal">Export Journal</button>
      <button id="exportChat">Export Chat History</button>
    </section>

    <!-- ===================== MOOD OVERVIEW ===================== -->
    <section aria-label="Mood Overview">
      <h2>üìä Mood Overview</h2>
      <div class="chart-container">
        <div class="chart-wrapper">
          <canvas id="moodLineChart"></canvas>
        </div>
        <div class="pie-wrapper">
          <canvas id="moodPieChart"></canvas>
        </div>
      </div>
      <div id="moodEntries"></div>
    </section>

    <!-- ===================== ANXIETY TREND ===================== -->
    <section aria-label="Anxiety Trend">
      <h2>üìâ Anxiety Reduction Over Time</h2>
      <div class="chart-container">
        <div class="chart-wrapper">
          <canvas id="anxietyChart"></canvas>
        </div>
      </div>
    </section>

    <!-- ===================== JOURNAL ENTRIES ===================== -->
    <section aria-label="Journal Entries">
      <h2>üìî Journal Entries</h2>
      <div id="journalEntries"></div>
    </section>

    <!-- ===================== SAVED CHATS ===================== -->
    <section aria-label="Saved Chats">
      <h2>üí¨ Saved Chats</h2>
      <div id="savedChats"></div>
    </section>

  </main>
<script>
document.addEventListener("DOMContentLoaded", () => {

  /* ======================================================
     üåó THEME + NAV
  ====================================================== */
  const themeToggle = document.getElementById("themeToggle");
  const hamburger = document.querySelector(".tm-hamburger");
  const nav = document.querySelector(".tm-nav");
  const searchInput = document.getElementById("searchJournal");
  const dateRangeSelect = document.getElementById("dateRange");

  if (localStorage.getItem("theme") === "dark") {
    document.body.classList.add("dark-theme");
    themeToggle.textContent = "‚òÄÔ∏è Theme";
  }

  themeToggle.addEventListener("click", () => {
    document.body.classList.toggle("dark-theme");
    const isDark = document.body.classList.contains("dark-theme");
    localStorage.setItem("theme", isDark ? "dark" : "light");
    themeToggle.textContent = isDark ? "‚òÄÔ∏è Theme" : "üåô Theme";
    redrawVisuals();
  });

  function updateHamburgerVisibility() {
    if (window.innerWidth <= 768) {
      hamburger.style.display = "block";
    } else {
      hamburger.style.display = "none";
      nav.classList.remove("show-links");
    }
  }

  hamburger.addEventListener("click", () => nav.classList.toggle("show-links"));
  updateHamburgerVisibility();
  window.addEventListener("resize", updateHamburgerVisibility);

  /* ======================================================
     ‚ú® PARTICLES (FIXED & OPTIMIZED)
  ====================================================== */
  let particlesInstance = null;

  async function loadParticles() {
    if (window.matchMedia("(prefers-reduced-motion: reduce)").matches) return;

    const primaryColor = getComputedStyle(document.body)
      .getPropertyValue("--primary")
      .trim();

    if (particlesInstance) {
      await particlesInstance.destroy();
    }

    particlesInstance = await tsParticles.load("tsparticles", {
      fullScreen: { enable: true, zIndex: 0 },
      detectRetina: true,
      particles: {
        number: { value: window.innerWidth < 768 ? 30 : 45 },
        color: { value: primaryColor },
        opacity: { value: 0.35 },
        size: { value: { min: 1, max: 2 } },
        move: {
          enable: true,
          speed: 0.6,
          outModes: "out"
        },
        links: {
          enable: true,
          distance: 120,
          opacity: 0.35,
          color: primaryColor
        }
      }
    });
  }

  loadParticles();

  /* ======================================================
     üì¶ DATA HELPERS
  ====================================================== */
  const getJournalData = () => JSON.parse(localStorage.getItem("journalData") || "[]");
  const getChatHistory = () => JSON.parse(localStorage.getItem("chatHistory") || "[]");
  const getBreathingSessions = () => JSON.parse(localStorage.getItem("breathingSessions") || "[]");

  const parseEntryDate = e => e.date ? new Date(e.date) : null;

  let journalDataRaw = getJournalData();
  let filteredJournalData = journalDataRaw.slice();

  /* ======================================================
     üîé FILTERING
  ====================================================== */
  function filterByDateRange(data) {
    const val = dateRangeSelect.value;
    if (val === "all") return data.slice();
    const cutoff = new Date(Date.now() - parseInt(val) * 86400000);
    return data.filter(e => !parseEntryDate(e) || parseEntryDate(e) >= cutoff);
  }

  function applyFilters() {
    filteredJournalData = filterByDateRange(journalDataRaw);
    renderMoodEntries();
    renderJournalEntries(searchInput.value);
    buildCharts();
    buildAnxietyChart(filteredJournalData);
    renderSummary();
  }

  /* ======================================================
     üòä MOOD ENTRIES
  ====================================================== */
  const moodEntriesDiv = document.getElementById("moodEntries");

  function renderMoodEntries() {
    moodEntriesDiv.innerHTML = "";
    const moods = filteredJournalData.filter(e => e.mood).slice(-5).reverse();

    if (!moods.length) {
      moodEntriesDiv.innerHTML = `<p class="empty-state">No mood data found.</p>`;
      return;
    }

    moods.forEach(e => {
      moodEntriesDiv.innerHTML += `
        <div class="entry">
          <small>${e.date || ""}</small>
          <strong>${e.mood}</strong>
          ${e.tags ? `<small>Tags: ${e.tags}</small>` : ""}
          <div>${e.entry || ""}</div>
        </div>`;
    });
  }

  /* ======================================================
     üìî JOURNAL ENTRIES
  ====================================================== */
  const journalEntriesDiv = document.getElementById("journalEntries");

  function renderJournalEntries(query = "") {
    journalEntriesDiv.innerHTML = "";
    const q = query.toLowerCase();

    const entries = filteredJournalData.filter(e =>
      [e.title, e.entry, e.tags, e.mood].join(" ").toLowerCase().includes(q)
    );

    if (!entries.length) {
      journalEntriesDiv.innerHTML = `<p class="empty-state">No entries found.</p>`;
      return;
    }

    entries.sort((a,b)=>(parseEntryDate(b)||0)-(parseEntryDate(a)||0));

    entries.forEach(e => {
      journalEntriesDiv.innerHTML += `
        <div class="entry">
          <small>${e.date || ""}</small>
          ${e.mood ? `<strong>${e.mood}</strong>` : ""}
          ${e.tags ? `<small>Tags: ${e.tags}</small>` : ""}
          ${e.title ? `<strong>${e.title}</strong>` : ""}
          <div>${e.entry || ""}</div>
        </div>`;
    });
  }

  searchInput.addEventListener("input", () => renderJournalEntries(searchInput.value));
  dateRangeSelect.addEventListener("change", applyFilters);

  /* ======================================================
     üìä MOOD CHARTS (SAFE BUILD)
  ====================================================== */
  const moodScoreMap = {
    "üòÉ Happy": 5, "üòå Calm": 4, "üòî Sad": 2,
    "üò® Anxious": 2, "üò† Angry": 1, "üòµ Overwhelmed": 1
  };

  let moodLineChart, moodPieChart;

  function buildCharts() {
    moodLineChart?.destroy();
    moodPieChart?.destroy();

    const moods = filteredJournalData.filter(e => e.mood);
    if (!moods.length) return;

    moodLineChart = new Chart(
      document.getElementById("moodLineChart"),
      {
        type: "line",
        data: {
          labels: moods.map(e => e.date || ""),
          datasets: [{
            data: moods.map(e => moodScoreMap[e.mood] || 3),
            borderColor: "#4f46e5",
            fill: true
          }]
        },
        options: { plugins: { legend: { display: false } } }
      }
    );

    const counts = {};
    moods.forEach(e => counts[e.mood] = (counts[e.mood] || 0) + 1);

    moodPieChart = new Chart(
      document.getElementById("moodPieChart"),
      {
        type: "pie",
        data: {
          labels: Object.keys(counts),
          datasets: [{ data: Object.values(counts) }]
        }
      }
    );
  }

  /* ======================================================
     üìâ ANXIETY TREND
  ====================================================== */
  let anxietyChart;

  function buildAnxietyChart(entries) {
    anxietyChart?.destroy();

    const anxietyMoods = ["üò® Anxious", "üòµ Overwhelmed"];
    const weekly = {};

    entries.forEach(e => {
      if (anxietyMoods.includes(e.mood) && e.date) {
        const key = e.date.slice(0,7);
        weekly[key] = (weekly[key] || 0) + 1;
      }
    });

    anxietyChart = new Chart(
      document.getElementById("anxietyChart"),
      {
        type: "line",
        data: {
          labels: Object.keys(weekly),
          datasets: [{
            data: Object.values(weekly),
            borderColor: "#f97316",
            fill: true
          }]
        },
        options: { plugins: { legend: { display: false } } }
      }
    );
  }

  /* ======================================================
     üìä SUMMARY DASHBOARD
  ====================================================== */
  const circumference = 264;

  function calculateBreathingStreak(sessions) {
    const days = [...new Set(sessions.map(s => s.date))].sort().reverse();
    let streak = 0, prev = new Date();
    for (const d of days) {
      const cur = new Date(d);
      if ((prev - cur) / 86400000 <= 1) { streak++; prev = cur; }
      else break;
    }
    return streak;
  }

  function calculateWellness(journals, breathing, chats) {
    const avgMood = journals.reduce((s,e)=>s+(moodScoreMap[e.mood]||3),0)/(journals.length||1);
    return Math.round(
      (avgMood / 5) * 40 +
      Math.min(journals.length * 2, 20) +
      Math.min(breathing.length * 3, 20) +
      Math.min(chats.length * 1.5, 20)
    );
  }

  function renderSummary() {
    const breathing = getBreathingSessions();
    const chats = getChatHistory();
    const score = calculateWellness(filteredJournalData, breathing, chats);

    document.getElementById("wellnessScore").textContent = score;

    const ring = document.querySelector(".ring-progress");
    ring.style.strokeDashoffset = circumference - (score / 100) * circumference;
    ring.style.stroke =
      score >= 75 ? "#22c55e" :
      score >= 45 ? "#facc15" :
      "#ef4444";

    document.getElementById("breathingCount").textContent = breathing.length;
    document.getElementById("breathingStreak").textContent =
      calculateBreathingStreak(breathing);
  }

  /* ======================================================
     üîò WEEKLY / MONTHLY TOGGLE
  ====================================================== */
  document.querySelectorAll(".range-toggle").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".range-toggle").forEach(b => {
        b.classList.remove("active");
        b.setAttribute("aria-pressed", "false");
      });
      btn.classList.add("active");
      btn.setAttribute("aria-pressed", "true");
      dateRangeSelect.value = btn.dataset.range;
      applyFilters();
    });
  });

  /* ======================================================
     üí¨ SAVED CHATS
  ====================================================== */
  function loadSavedChats() {
    fetch("/get_conversations")
      .then(r => r.ok ? r.json() : [])
      .then(chats => {
        const div = document.getElementById("savedChats");
        div.innerHTML = chats.length ? "" : `<p class="empty-state">No saved chats yet.</p>`;
        chats.forEach(c => {
          div.innerHTML += `
            <div class="saved-chat-card">
              <div class="saved-chat-title">${c.title || "Untitled Chat"}</div>
              <div class="saved-chat-meta">${c.created_at || ""}</div>
              <button onclick="location.href='/index'">Open in Chat</button>
            </div>`;
        });
      });
  }

  /* ======================================================
     üîÑ REDRAW & INIT
  ====================================================== */
  function redrawVisuals() {
    loadParticles();
    buildCharts();
    buildAnxietyChart(filteredJournalData);
    renderSummary();
  }

  applyFilters();
  loadSavedChats();

});
</script>

</body>
</html>
