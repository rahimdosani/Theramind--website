<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Theramind ‚Äì Journal</title>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='journal.png') }}">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Shadows+Into+Light&family=Merriweather&family=Roboto+Mono&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.12.0/tsparticles.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  /* =====================
     Theme Variables
     ===================== */
  :root {
    --background: #ffffff;
    --foreground: #111111;
    --primary: #4f46e5;
    --accent: #06b6d4;
    --sidebar-bg: rgba(255, 255, 255, 0.85);
    --glass-blur: blur(16px) saturate(180%);
    --button-color: #ffffff;
  }

  body.dark-theme {
    --background: #0b0c1a;
    --foreground: #f5f7ff;
    --primary: #4f6df5;
    --accent: #4fd1c5;
    --sidebar-bg: rgba(20, 22, 40, 0.85);
  }

  /* =====================
     Base Reset
     ===================== */
  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    font-family: "Poppins", sans-serif;
    background: var(--background);
    color: var(--foreground);
    transition: background 0.3s, color 0.3s;
  }

  #tsparticles {
    position: fixed;
    inset: 0;
    z-index: 1;
  }

  /* =====================
     Top Navigation
     ===================== */
  .tm-nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 75px;
    padding: 0 2rem;
    background: var(--sidebar-bg);
    backdrop-filter: var(--glass-blur);
    box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .tm-brand {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-weight: 700;
    font-size: 1.4rem;
    color: var(--foreground);
    text-decoration: none;
  }

  .tm-brand img.brand-mark {
    height: 36px;
  }

  .tm-navlinks {
    display: flex;
    gap: 1.5rem;
    align-items: center;
    flex-wrap: wrap;
  }

  .tm-navlinks a {
    text-decoration: none;
    font-weight: 600;
    color: var(--primary);
    position: relative;
    transition: color 0.3s;
  }

  .tm-navlinks a:hover {
    color: var(--accent);
  }

  .tm-navlinks a.active::after {
    content: "";
    position: absolute;
    bottom: -6px;
    left: 0;
    width: 100%;
    height: 3px;
    background: var(--primary);
    border-radius: 4px;
  }

  .theme-toggle {
    cursor: pointer;
    font-size: 0.9rem;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    padding: 6px 10px;
    border-radius: 6px;
    color: var(--button-color);
    transition: opacity 0.3s;
  }

  .theme-toggle:hover {
    opacity: 0.85;
  }
  /* =====================
   Chat-style Mobile Sidebar
===================== */
.tm-sidebar {
  background: var(--sidebar-bg);
  backdrop-filter: var(--glass-blur);
  width: 260px;
  padding: 1.5rem 1.2rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  box-shadow: 4px 0 20px rgba(0,0,0,0.2);
  border-radius: 0 14px 14px 0;
}

.sidebar-nav a {
  text-decoration: none;
  font-weight: 600;
  padding: 0.6rem 0.8rem;
  border-radius: 10px;
  color: var(--foreground);
}

.sidebar-nav a.active {
  background: linear-gradient(135deg, var(--primary), var(--accent));
  color: #fff;
}


  /* =====================
     Journal Layout
     ===================== */
  .journal-container {
    max-width: 900px;
    margin: 100px auto;
    padding: 40px;
    background: rgba(255, 255, 255, 0.08);
    border-radius: 20px;
    backdrop-filter: blur(12px);
    position: relative;
    z-index: 2;
    box-shadow: 0 8px 40px rgba(0, 0, 0, 0.2);
  }

  body.dark-theme .journal-container {
    background-color: rgba(44, 44, 62, 0.8);
  }

  h2 {
    font-size: 2rem;
    margin-bottom: 20px;
  }

  .mood-select,
  .prompt-section,
  .entry-section,
  .history-section {
    margin-top: 24px;
  }

  select,
  textarea,
  input[type="text"] {
    width: 100%;
    margin-top: 10px;
    padding: 12px;
    font-size: 1rem;
    border-radius: 10px;
    border: 1px solid #ccc;
    background-color: inherit;
    color: inherit;
    transition: 0.2s;
  }

  /* =====================
     Buttons
     ===================== */
  .prompt-section button,
  .actions button,
  .speech-button,
  #font-select,
  #export-all,
  #export-pdf {
    padding: 12px 18px;
    border: none;
    border-radius: 10px;
    background-color: var(--primary);
    color: var(--button-color);
    font-weight: 600;
    cursor: pointer;
    margin: 10px 10px 0 0;
    transition: background-color 0.2s;
  }

  .prompt-section button:hover,
  .actions button:hover,
  .speech-button:hover,
  #font-select:hover,
  #export-all:hover,
  #export-pdf:hover {
    background-color: var(--accent);
  }

  /* =====================
     Illustration
     ===================== */
  .illustration {
    text-align: center;
    margin-top: 16px;
  }

  .illustration img {
    max-width: 220px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    animation: float 3s ease-in-out infinite;
  }

  @keyframes float {
    0%,
    100% {
      transform: translateY(0);
    }
    50% {
      transform: translateY(-6px);
    }
  }

  /* =====================
     Insights Panel
     ===================== */
  .insights-card {
    margin: 16px 0;
    padding: 14px 16px;
    border-radius: 14px;
    background: var(--sidebar-bg);
    backdrop-filter: blur(14px);
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
  }

  .insights-card h3 {
    margin-bottom: 8px;
    font-size: 1rem;
    color: var(--primary);
  }

  .insights-card ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .insights-card li {
    font-size: 0.9rem;
    opacity: 0.85;
    margin-bottom: 6px;
  }

  .insights-card.hidden {
    display: none;
  }

  /* =====================
     Dark Mode Select Fix
     ===================== */
  select {
    background-color: var(--background);
    color: var(--foreground);
  }

  body.dark-theme select {
    background-color: #0f1225;
    color: #f5f7ff;
    border-color: rgba(255, 255, 255, 0.25);
  }

  body.dark-theme select option {
    background-color: #0f1225;
    color: #f5f7ff;
  }
  .icon-btn {
  background: linear-gradient(135deg, var(--primary), var(--accent));
  border: none;
  color: white;
  padding: 8px 12px;
  border-radius: 10px;
  font-size: 1.2rem;
  cursor: pointer;
}

.mobile-only {
  display: none;
}

@media (max-width: 1024px) {
  .mobile-only {
    display: inline-flex;
  }
}


  /* =====================
     Responsive
     ===================== */
  @media (max-width: 768px) {
    .journal-container {
      margin: 60px 15px;
      padding: 25px;
    }

    h2 {
      font-size: 1.4rem;
    }
  }

  @media (max-width: 480px) {
    .journal-container {
      margin: 50px 10px;
      padding: 20px;
    }

    h2 {
      font-size: 1.2rem;
    }
  }
  @media (max-width: 1024px) {
  .tm-navlinks {
    display: none;
  }
}
@media (max-width: 768px) {
  .journal-container {
    margin-top: 80px;
  }
}
/* =====================
   Modal Visibility Fix
   ===================== */
.modal {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,0.45);
  z-index: 300;
}

.modal.active {
  display: flex;
}
@media (max-width: 1024px) {
  .tm-navlinks {
    display: none !important;
  }

  .tm-sidebar {
    position: fixed;
    top: 75px;
    left: 0;
    height: calc(100dvh - 75px);
    transform: translateX(-100%);
    z-index: 200;
  }

  .tm-sidebar.show {
    transform: translateX(0);
  }

  body.sidebar-open {
    overflow: hidden;
  }
}
@media (min-width: 1025px) {
  .tm-sidebar {
    display: none !important;
  }
}
.tm-sidebar {
  transition: transform 0.3s ease;
}



</style>

</head>
<body>
  <div id="tsparticles"></div>

  <!-- Navbar -->
  <header class="tm-nav">
    <a class="tm-brand" href="/home">
      <img src="https://img.icons8.com/fluency/48/brain.png" alt="Theramind Logo" class="brand-mark">
      <span>Theramind</span>
    </a>
    <nav class="tm-navlinks">
      <a href="/">üè† Home</a>
      <a href="/index">üí¨ Chat</a>
      <a href="/journaling" class="active">üìì Journal</a>
      <a href="/breathing">ü´Å Breathing</a>
      <a href="/pick-a-peace">üìÉ Pick-a-Peace</a>
      <a href="/calm-corner">üßò Calm Corner</a>
      <a href="/ebooks">üìö E-Books</a>
      <a href="/history">üï∞Ô∏è History</a>
    </nav>
    <div class="theme-toggle" id="themeToggle">üåì Theme</div>
    <button
  id="sidebarToggle"
  class="icon-btn mobile-only"
  aria-label="Toggle sidebar"
  aria-expanded="false"
>
  ‚ò∞
</button>


    
  </header>
  <aside id="sidebar" class="tm-sidebar" aria-label="Sidebar Navigation">

  <nav class="sidebar-nav mobile-only">
    <a href="/">üè† Home</a>
    <a href="/index">üí¨ Chat</a>
    <a href="/journaling" class="active">üìì Journal</a>
    <a href="/breathing">ü´Å Breathing</a>
    <a href="/pick-a-peace">üìÉ Pick-a-Peace</a>
    <a href="/calm-corner">üßò Calm Corner</a>
    <a href="/ebooks">üìö E-Books</a>
    <a href="/history">üï∞Ô∏è History</a>
  </nav>

</aside>

  <!-- Journal Container -->
  <div class="journal-container">
    <h2 id="journalGreeting">How are you feeling today?</h2>
    <!-- Reflection Insights -->
<div id="reflectionInsights" class="insights-card hidden">
  <h3>üß† Reflection Insights</h3>
  <ul>
    <li id="insightMood"></li>
    <li id="insightPattern"></li>
    <li id="insightEncouragement"></li>
  </ul>
</div>

    <div class="mood-select">
      <label>Select Your Mood:</label>
      <select id="moodSelect" onchange="updateIllustrationAndPrompt()">
        <option>üòÉ Happy</option>
        <option>üòî Sad</option>
        <option>üò† Angry</option>
        <option>üò® Anxious</option>
        <option>üòå Calm</option>
        <option>üòµ Overwhelmed</option>
      </select>
    </div>
    <div class="illustration"><img id="mood-image" /></div>
    <div class="prompt-section">
      <button onclick="generatePrompt()">üéØ Generate Prompt</button>
      <p id="prompt-display">Your prompt will appear here...</p>
    </div>
    <div class="entry-section">
      <input type="text" id="entry-title" placeholder="Entry Title" />
      <textarea id="journal-entry" placeholder="Start writing..."></textarea>
      <div class="actions">
        <button onclick="saveEntry()">üíæ Save Entry</button>
        <button class="speech-button" onclick="toggleDictation()">üé§ Start Dictation</button>
        <button onclick="readAloud()">üîä Read Journal</button>
        <select id="font-select" onchange="changeFont(this.value)">
          <option value="'Shadows Into Light',cursive">Font</option>
          <option value="'Merriweather',serif">Serif</option>
          <option value="'Poppins',sans-serif">Sans-serif</option>
          <option value="'Roboto Mono',monospace">Monospace</option>
          <option value="'Inter',sans-serif">Inter</option>
          <option value="'Playfair Display',serif">Playfair Display</option>
          <option value="'Source Serif 4',serif">Source Serif</option>

        </select>
        <button onclick="exportPDF()">üìÑ Export PDF</button>
        <button onclick="exportAll()">üì§ Export JSON</button>
      </div>
      <div class="search-tags">
        <input type="text" placeholder="Search journal..." oninput="searchJournal(this.value)">
        <input type="text" placeholder="Tag (comma separated)" id="tags">
      </div>
    </div>
    <div class="history-section">
      <h3>Previous Entries</h3>
      <div id="history" class="journal-history"></div>
    </div>
  </div>

  <!-- Modals -->
  <div class="modal" id="entryModal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal()">√ó</span>
      <h3 id="modal-title"></h3>
      <p id="modal-content"></p>
      <p id="modal-mood"></p>
      <p id="modal-tags"></p>
    </div>
  </div>
  <div class="toast" id="toast"></div>

  <div class="modal" id="deleteModal">
  <div class="modal-content">
    <h3>Delete journal entry?</h3>
    <p>This action cannot be undone.</p>
    <div style="margin-top:16px;display:flex;gap:10px;">
      <button onclick="confirmDelete()" style="background:#e53e3e;color:white;">Delete</button>
      <button onclick="closeDeleteModal()">Cancel</button>
    </div>
  </div>
</div>


<script>
  const JOURNAL_DRAFT_KEY = "journalDraft";

function autoSaveDraft() {
  const entry = document.getElementById("journal-entry").value.trim();
  if (!entry) return;

  localStorage.setItem(
    JOURNAL_DRAFT_KEY,
    JSON.stringify({
      title: document.getElementById("entry-title").value,
      mood: document.getElementById("moodSelect").value,
      content: entry,
      timestamp: Date.now()
    })
  );

  showToast("Draft saved quietly");
}

  // --- Session-aware Journal Greeting ---
const JOURNAL_USER_NAME = localStorage.getItem("userName");
const JOURNAL_GREETING_SHOWN =
  sessionStorage.getItem("journalGreetingShown") === "true";

function setJournalGreeting() {
  const el = document.getElementById("journalGreeting");
  if (!el) return;

  if (!JOURNAL_GREETING_SHOWN) {
    el.textContent = JOURNAL_USER_NAME
      ? `Welcome back, ${JOURNAL_USER_NAME}. How are you feeling today?`
      : "Welcome back. How are you feeling today?";

    sessionStorage.setItem("journalGreetingShown", "true");
  } else {
    el.textContent = "How are you feeling right now?";
  }
}

function generateReflectionInsights() {
  if (!journalData || journalData.length < 1) return;

  const insightsEl = document.getElementById("reflectionInsights");
  if (!insightsEl) return;

  // Filter last 7 days
  const oneWeekAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
  const recentEntries = journalData.filter(e => {
  const d = new Date(e.date).getTime();
  return !isNaN(d) && d >= oneWeekAgo;
});


  if (recentEntries.length === 0) return;

  // Mood frequency
  const moodCount = {};
  recentEntries.forEach(e => {
    if (e.mood) moodCount[e.mood] = (moodCount[e.mood] || 0) + 1;
  });

  const dominantMood = Object.keys(moodCount).reduce((a, b) =>
    moodCount[a] > moodCount[b] ? a : b
  );

  // Writing length vs mood
  const lengthByMood = {};
  recentEntries.forEach(e => {
    if (!e.mood || !e.content) return;
    if (!lengthByMood[e.mood]) lengthByMood[e.mood] = [];
    lengthByMood[e.mood].push(e.content.length);
  });

  let longestMood = null;
  let longestAvg = 0;
  Object.keys(lengthByMood).forEach(m => {
    const avg =
      lengthByMood[m].reduce((a, b) => a + b, 0) /
      lengthByMood[m].length;
    if (avg > longestAvg) {
      longestAvg = avg;
      longestMood = m;
    }
  });

  // Populate UI
  document.getElementById("insightMood").textContent =
    `Most frequent mood this week: ${dominantMood}`;

  document.getElementById("insightPattern").textContent =
    longestMood
      ? `You tend to write longer entries when you feel ${longestMood}.`
      : `Your writing patterns are becoming more consistent.`;

  document.getElementById("insightEncouragement").textContent =
    `Regular journaling helps build self-awareness over time.`;

  insightsEl.classList.remove("hidden");
}

document.addEventListener("DOMContentLoaded", () => {
  tsParticles.load("tsparticles", {
     background: { color: { value: "transparent" } },
  fullScreen: false,
  particles: {
    number: {
      value: 70,
      density: { enable: true, area: 800 }
    },
    color: {
      value: ["#6b7cff", "#67e8f9"]
    },
    shape: { type: "circle" },
    opacity: {
      value: 0.35,
      random: true
    },
    size: {
      value: { min: 1.5, max: 3.5 }
    },
    links: {
      enable: true,
      distance: 120,
      color: "#aab8ff",
      opacity: 0.15,
      width: 1
    },
    move: {
      enable: true,
      speed: 0.6,
      direction: "none",
      outModes: "out"
    }
  }
});


  const themeToggle = document.getElementById("themeToggle");
  const prefersDark = localStorage.getItem("theme") === "dark";
  if(prefersDark){ document.body.classList.add("dark-theme"); themeToggle.textContent = "‚òÄÔ∏è Theme"; }
  else{ document.body.classList.remove("dark-theme"); themeToggle.textContent = "üåô Theme"; }

  themeToggle.addEventListener("click", toggleTheme);

  const draft = localStorage.getItem(JOURNAL_DRAFT_KEY);
  if (draft) {
    try {
      const d = JSON.parse(draft);
      document.getElementById("entry-title").value = d.title || "";
      document.getElementById("moodSelect").value = d.mood || "";
      document.getElementById("journal-entry").value = d.content || "";
      showToast("Draft restored");
    } catch (e) {
      console.warn("Failed to restore journal draft", e);
    }
  }

  loadHistory();
  updateIllustrationAndPrompt();
  setInterval(autoSaveDraft, 5000);
  setJournalGreeting();
});


function showToast(msg){ const toast=document.getElementById("toast"); toast.textContent=msg; toast.classList.add("show"); setTimeout(()=>{toast.classList.remove("show");},2500); }

function toggleTheme(){
  const themeToggle=document.getElementById("themeToggle");
  document.body.classList.toggle("dark-theme");
  const isDark=document.body.classList.contains("dark-theme");
  localStorage.setItem("theme", isDark?"dark":"light");
  themeToggle.textContent=isDark?"‚òÄÔ∏è Theme":"üåô Theme";
  showToast("Theme changed");
}

// --- Prompts + Mood Images ---
const promptMap = {
  "üòÉ Happy": ["What made you smile today?","Who brought joy into your life today?","What small victory did you achieve today?","Which moment made you laugh out loud?","What are you grateful for today?","Describe a joyful interaction you had.","What inspired your happiness today?","How can you spread positivity?","Share a happy memory from today.","What energized you today?"],
  "üòî Sad": ["What‚Äôs weighing on your heart?","How are you comforting yourself today?","What made you feel low today?","Describe a moment of sadness today.","What would help lighten your mood?","Who or what can support you today?","Reflect on a challenging emotion.","How can you nurture yourself?","What lesson does your sadness teach?","Share a moment of vulnerability today."],
  "üò† Angry": ["What triggered your anger?","How can you express it constructively?","Which situation frustrated you?","What could have gone differently?","How can you release anger safely?","Identify any unfair treatment today.","How did you respond to your anger?","What emotions lie beneath your anger?","Share an experience where you stayed calm.","What steps can prevent anger tomorrow?"],
  "üò® Anxious": ["What's causing anxiety right now?","What can you control in this moment?","Which thoughts are overwhelming you?","How can you ground yourself?","What support can you seek?","Describe your anxious feelings.","What steps help reduce stress?","Identify triggers for anxiety today.","Reflect on past moments you managed anxiety.","What reassures you?"],
  "üòå Calm": ["What brings you peace?","Today I feel calm because‚Ä¶","Describe a serene moment you had.","What activities help you relax?","Who contributes to your tranquility?","How did you manage stress today?","Reflect on mindful breathing moments.","What music or sounds soothe you?","Share a quiet moment from today.","What positive thoughts keep you grounded?"],
  "üòµ Overwhelmed": ["What‚Äôs making you feel overwhelmed?","Break down your feelings into parts.","Identify top stressors today.","Which tasks are weighing on you?","What is outside your control?","What small wins occurred today?","How can you prioritize tasks?","Who can help you manage responsibilities?","Reflect on emotions and reactions.","How can you reset and recharge?"]
};
const imageMap = {
  "üòÉ Happy":"https://img.icons8.com/emoji/96/000000/smiling-face-with-smiling-eyes.png",
  "üòî Sad":"https://img.icons8.com/emoji/96/000000/pensive-face.png",
  "üò† Angry":"https://img.icons8.com/emoji/96/000000/pouting-face.png",
  "üò® Anxious":"https://img.icons8.com/emoji/96/000000/fearful-face.png",
  "üòå Calm":"https://img.icons8.com/emoji/96/000000/relieved-face.png",
  "üòµ Overwhelmed":"https://img.icons8.com/emoji/96/000000/dizzy-face.png"
};

function updateIllustrationAndPrompt() {
  const select = document.getElementById("moodSelect");
  if (!select || !select.value || !imageMap[select.value]) return;

  document.getElementById("mood-image").src = imageMap[select.value];
  generatePrompt();
}


function generatePrompt() {
  const mood = document.getElementById("moodSelect").value;
  const prompts = promptMap[mood];
  const prompt = prompts[Math.floor(Math.random() * prompts.length)];
  document.getElementById("prompt-display").textContent = prompt;
  document.getElementById("journal-entry").placeholder = prompt.startsWith("Today") ? prompt : "";
}

// --- Journal Storage + Functions ---
let journalData = [];
let currentModalIndex = 0;

async function loadHistory() {
  const container = document.getElementById("history");
  container.innerHTML = "Loading‚Ä¶";

  try {
    const res = await fetch("/api/history/journals");
    if (!res.ok) throw new Error();

    journalData = await res.json();
    container.innerHTML = "";

    if (!journalData.length) {
      container.textContent = "No previous entries yet.";
      return;
    }

    journalData.forEach((rec, i) => {
      const div = document.createElement("div");
      div.className = "entry-item";
      div.innerHTML = `
        <span>${rec.date} [${rec.mood || "‚Äî"}]</span>
        <div class="entry-actions">
          <button onclick="deleteEntry(${i})">üóëÔ∏è</button>
        </div>
      `;
      div.addEventListener("click", e => {
        if (!e.target.closest("button")) openModal(i);
      });
      container.appendChild(div);
    });

    generateReflectionInsights();

  } catch {
    container.textContent = "Could not load journal history.";
  }
}


function openModal(index) {
  currentModalIndex=index;
  const entry=journalData[index];
  document.getElementById("modal-title").textContent=entry.title;
  document.getElementById("modal-content").textContent=entry.entry;
  document.getElementById("modal-tags").textContent=entry.tags?`Tags: ${entry.tags}`:'';
  document.getElementById("modal-mood").textContent=`Mood: ${entry.mood}`;
  document.getElementById("entryModal").classList.add("active");
}
function closeModal() { document.getElementById("entryModal").classList.remove("active"); }

let deleteIndex = null;

function deleteEntry(i){
  deleteIndex = i;
  document.getElementById("deleteModal").classList.add("active");
}

function closeDeleteModal(){
  document.getElementById("deleteModal").classList.remove("active");
  deleteIndex = null;
}

async function confirmDelete() {
  if (deleteIndex === null || !journalData[deleteIndex]) {
    closeDeleteModal();
    return;
  }

  const entryId = journalData[deleteIndex].id;

  try {
    const res = await fetch(`/api/journals/${entryId}`, {
      method: "DELETE",
    });

    if (!res.ok) throw new Error("Delete failed");

    showToast("Entry deleted üóëÔ∏è");
    await loadHistory(); // reload from backend

  } catch (err) {
    console.error(err);
    showToast("Could not delete entry.");
  }

  closeDeleteModal();
}

async function saveEntry() {
  const title =
    document.getElementById("entry-title").value.trim() || "Untitled";
  const entry =
    document.getElementById("journal-entry").value.trim();
  const mood =
    document.getElementById("moodSelect").value;
  const tags =
    document.getElementById("tags").value;

  if (!entry) {
    showToast("Please write something.");
    return;
  }

  try {
    const res = await fetch("/journaling", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        title,
        content: entry,
        mood,
        tags,
      }),
    });

    if (!res.ok) throw new Error("Save/job failed");

    // Clear inputs
    document.getElementById("journal-entry").value = "";
    document.getElementById("entry-title").value = "";
    document.getElementById("tags").value = "";

    // Refresh history from backend
    await loadHistory();

    showToast("Entry saved!");
    localStorage.removeItem(JOURNAL_DRAFT_KEY);

  } catch (err) {
    console.error(err);
    showToast("Could not save entry. Please try again.");
  }
}

function searchJournal(query){
  const container=document.getElementById("history");
  const filtered=journalData.filter(rec=>
    rec.title.toLowerCase().includes(query.toLowerCase())||
    rec.entry.toLowerCase().includes(query.toLowerCase())||
    (rec.tags && rec.tags.toLowerCase().includes(query.toLowerCase()))
  );
  container.innerHTML='';
  if(!filtered.length){ container.textContent="No entries match your search."; return; }
  filtered.forEach((rec,i)=>{
    const div=document.createElement("div");
    div.className="entry-item";
    div.innerHTML=`<span>${rec.date} - ${rec.title} [${rec.mood}]</span>
                   <div class="entry-actions"><button onclick="deleteEntry(${i})">üóëÔ∏è</button></div>`;
    div.addEventListener("click",(e)=>{if(!e.target.closest("button")) openModal(i)});
    container.appendChild(div);
  });
}

function changeFont(font){ document.getElementById("journal-entry").style.fontFamily=font; showToast("Font changed!"); }

function readAloud(){
  const text=document.getElementById("journal-entry").value;
  if(!text){ showToast("No text to read."); return; }
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = detectJournalLanguage(text);
  speechSynthesis.speak(utter);
  showToast("Reading aloud...");
}

function detectJournalLanguage(text) {
  // Hindi vs English
  return /[‡§Ä-‡•ø]/.test(text) ? "hi-IN" : "en-IN";
}
let recognition, recognizing=false;
function toggleDictation(){
  const SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SpeechRecognition){showToast("Speech recognition not supported."); return;}
  if(!recognition){
    recognition=new SpeechRecognition();
    recognition.continuous=true;
    recognition.lang = detectJournalLanguage(
  document.getElementById("journal-entry").value || ""
);

    recognition.onresult=(e)=>{
      for(let i=e.resultIndex;i<e.results.length;i++){
        if(e.results[i].isFinal)
          document.getElementById("journal-entry").value+=e.results[i][0].transcript+" ";
      }
    };
    recognition.onerror=(e)=>showToast("Speech recognition error: "+e.error);
  }
  const btn=document.querySelector('.speech-button');
  if(!recognizing){
    recognition.start();
    recognizing=true;
    btn.style.background="#3e53cc";
    btn.textContent='üõë Stop Dictation';
    showToast("Dictation started");
  } else {
    recognition.stop();
    recognizing=false;
    btn.style.background="#4f6df5";
    btn.textContent='üé§ Start Dictation';
    showToast("Dictation stopped");
  }
}

async function exportPDF() {
  try {
    const res = await fetch("/api/history/journals");
    if (!res.ok) throw new Error("Failed to fetch journals");

    const journalData = await res.json();

    if (!journalData.length) {
      showToast("No entries to export.");
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    journalData.forEach((entry, idx) => {
      doc.setFontSize(12);
      doc.text(
        `Entry ${idx + 1} ‚Äì ${entry.mood || ""} ‚Äì ${entry.date}`,
        10,
        15
      );
      doc.setFontSize(10);
      doc.text(entry.entry || "", 10, 25, { maxWidth: 180 });

      if (entry.tags) {
        doc.text(`Tags: ${entry.tags}`, 10, 40);
      }

      if (idx < journalData.length - 1) doc.addPage();
    });

    doc.save("Theramind_Journal.pdf");
    showToast("PDF exported!");

  } catch (err) {
    console.error(err);
    showToast("Could not export PDF.");
  }
}

async function exportAll() {
  try {
    const res = await fetch("/api/history/journals");
    if (!res.ok) throw new Error("Failed to fetch journals");

    const journalData = await res.json();

    if (!journalData.length) {
      showToast("No entries to export.");
      return;
    }

    const blob = new Blob(
      [JSON.stringify(journalData, null, 2)],
      { type: "application/json" }
    );

    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "Theramind_Journal.json";

    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    showToast("All entries exported!");

  } catch (err) {
    console.error(err);
    showToast("Could not export entries.");
  }
}


const sidebar = document.getElementById("sidebar");
const sidebarToggle = document.getElementById("sidebarToggle");

sidebarToggle?.addEventListener("click", () => {
  sidebar.classList.toggle("show");
  document.body.classList.toggle("sidebar-open");

  const isOpen = sidebar.classList.contains("show");
  sidebarToggle.setAttribute("aria-expanded", isOpen);

  // Accessibility polish
  if (isOpen) {
    sidebar.querySelector("a")?.focus();
  }
});
</script>
</body>
</html>
